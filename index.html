<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Заявка на инвестиционный проект — Корпорация развития РБ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #00A950;
            --bg-light: #ffffff;
            --bg-secondary: #f3f3f3;
            --text: #0b1220;
            --hint: #666;
            --link: #2481cc;
            --btn-text: #ffffff;
        }
        [data-theme="dark"] {
            --bg-light: #0f1720;
            --bg-secondary: #121826;
            --text: #eef2f6;
            --hint: #9aa7b2;
            --link: #62bcf9;
        }
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Manrope', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: var(--bg-light);
            color: var(--text);
        }
        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 18px;
        }
        .card {
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 14px;
            box-shadow: 0 4px 18px rgba(12, 20, 28, 0.06);
        }
        .header {
            text-align: center;
            margin-bottom: 12px;
        }
        .header img {
            width: 56px;
            height: 56px;
        }
        h1 { font-size: 20px; margin: 8px 0 0; }
        p.lead { margin: 6px 0 18px; color: var(--hint); font-size: 14px; }

        label { display:block; font-weight:600; font-size:13px; color:var(--hint); margin-bottom:6px; }
        input, textarea, select {
            width:100%; padding:12px; border-radius:10px; border: none; box-sizing:border-box;
            font-size:15px; background:var(--bg-light); color:var(--text);
            box-shadow: inset 0 0 0 1px rgba(12,20,28,0.04);
        }
        textarea { min-height:100px; resize: vertical; }
        .grid { display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
        .full { grid-column: 1 / -1; }
        .hint { color:var(--hint); font-size:12px; margin-top:6px; }

        /* Main button styles are handled by Telegram WebApp MainButton, we keep a local submit button hidden for fallback */
        #submit-btn { display:none; }

        .small-row { display:flex; gap:8px; align-items:center; margin-top:8px; }
        .small-row select { width:100%; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3d/Coat_of_arms_of_Bashkortostan.svg/200px-Coat_of_arms_of_Bashkortostan.svg.png" alt="Герб Республики Башкортостан">
        <h1>Заявка на инвестиционный проект</h1>
        <p class="lead">Заполните форму — AI подготовит для вас дорожную карту с сроками, ответственными и результатами.</p>
    </div>

    <form id="invest-form" class="card" novalidate>
        <div class="grid">
            <div class="full">
                <label for="project_name">Название проекта *</label>
                <input type="text" id="project_name" name="project_name" required placeholder="Эко-отель 'Шихан'">
            </div>

            <div>
                <label for="initiator">Инициатор (компания, руководитель) *</label>
                <input type="text" id="initiator" name="initiator" required placeholder="ООО 'БашТуризм', Иванов И.И.">
            </div>
            <div>
                <label for="contacts">Контакт (телефон, email) *</label>
                <input type="text" id="contacts" name="contacts" required placeholder="+7 900 000 00 00, ivanov@example.com">
            </div>

            <div>
                <label for="investment_sum">Сумма вложений, млн руб. *</label>
                <input type="number" id="investment_sum" name="investment_sum" required min="0" step="0.1" placeholder="150.5">
            </div>
            <div>
                <label for="jobs_created">Создаваемые рабочие места, чел. *</label>
                <input type="number" id="jobs_created" name="jobs_created" required min="1" step="1" placeholder="25">
            </div>

            <div>
                <label for="activity_type">Вид деятельности *</label>
                <select id="activity_type" name="activity_type" required>
                    <option value="пром. производство">Пром. производство</option>
                    <option value="пищевое производство">Пищевое производство</option>
                    <option value="с/х производство">Сельскохозяйственное производство</option>
                    <option value="туризм">Туризм</option>
                    <option value="придорожный сервис">Придорожный сервис</option>
                    <option value="торговля">Торговля</option>
                    <option value="другое">Другое</option>
                </select>
            </div>
            <div>
                <label for="location">Желаемое местоположение *</label>
                <input type="text" id="location" name="location" required placeholder="г. Уфа, Белебей, Кумертау">
                <div class="hint">Укажите город или район в РБ. Для ТОР важен точный город (Кумертау, Благовещенск, Белорецк, Нефтекамск, Белебей).</div>
            </div>

            <div class="full">
                <label for="description">Краткое описание проекта / комментарии</label>
                <textarea id="description" name="description" placeholder="Кратко опишите суть проекта, стек, если есть (производство, мощность и т.д.)"></textarea>
            </div>
        </div>

        <!-- Фолбэк-кнопка (скрыта) -->
        <button id="submit-btn" type="button">Отправить заявку</button>
    </form>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tg = window.Telegram.WebApp;
        tg.ready();
        // Темы
        if (tg.colorScheme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
        tg.onEvent('themeChanged', () => document.documentElement.setAttribute('data-theme', tg.colorScheme));
        try { tg.expand(); } catch (e) {}

        const mainButton = tg.MainButton;
        mainButton.setText("Отправить заявку");
        // Установка цвета кнопки. Используем безопасный метод setParams, если доступен.
        try {
            if (mainButton.setParams) {
                mainButton.setParams({ color: '#00A950', text_color: '#ffffff' });
            } else {
                // fallback: ничего не делаем, telegram применит дефолтные цвета
            }
        } catch (e) {
            console.warn('MainButton.setParams not available', e);
        }
        mainButton.show();

        const form = document.getElementById('invest-form');

        function normalizeAndValidateData() {
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            // Приводим числовые поля к числам (чтобы модель получила числа, а не строки)
            if (data.investment_sum !== undefined && data.investment_sum !== "") {
                const n = Number(String(data.investment_sum).replace(',', '.'));
                data.investment_sum = Number.isFinite(n) ? Math.round(n * 10) / 10 : null;
            } else {
                data.investment_sum = null;
            }

            if (data.jobs_created !== undefined && data.jobs_created !== "") {
                const j = parseInt(data.jobs_created, 10);
                data.jobs_created = Number.isFinite(j) ? j : null;
            } else {
                data.jobs_created = null;
            }

            // Стриг и очистка
            data.project_name = (data.project_name || "").trim();
            data.initiator = (data.initiator || "").trim();
            data.contacts = (data.contacts || "").trim();
            data.activity_type = (data.activity_type || "").trim();
            data.location = (data.location || "").trim();
            data.description = (data.description || "").trim();

            return data;
        }

        function updateButtonState() {
            // простая валидация через HTML-функции
            const isValid = form.checkValidity();
            if (isValid) mainButton.enable(); else mainButton.disable();
        }

        // инициализация
        updateButtonState();
        form.addEventListener('input', updateButtonState);
        form.addEventListener('change', updateButtonState);

        mainButton.onClick(function () {
            // отбой, если невалидно
            if (!form.checkValidity()) {
                tg.showAlert('Пожалуйста, заполните все обязательные поля, отмеченные *.');
                return;
            }
            mainButton.showProgress();

            const data = normalizeAndValidateData();

            // Отправляем JSON — числа уже приведены к числовому виду там, где возможно
            try {
                tg.sendData(JSON.stringify(data));
            } catch (e) {
                console.error('tg.sendData failed', e);
                // фолбэк: показываем алерт
                tg.showAlert('Не удалось отправить данные через WebApp. Пожалуйста, попробуйте ещё раз.');
            } finally {
                mainButton.hideProgress();
            }
        });
    });
</script>
</body>
</html>
